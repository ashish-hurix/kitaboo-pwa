var ref,popover,bt={loadPopup:function(e,t,a,r){loadPopup(e,t,a,r)},htmlActivity:function(e,t,a){htmlActivity(e,t,a)},jumpToPage:function(e,t){jumpToPage(e,t)},videoKalturaInlineBlob:function(e){videoKalturaInlineBlob(e)},webLinks:function(e){webLinks(e)},openHotspots:function(e,t){openHotspots(e,t)},glossaryBlob:function(e,t){glossaryBlob(e,t)}};function getAbsolutePath(e){if(isExternal(e))return e;if("unknown"==DetectBrowser())return e;var t;if(e=e.replace("./",""),"baseURI"in document)t=document.baseURI.substring(0,document.baseURI.lastIndexOf("/")+1)+e;else{var a=document.getElementsByTagName("base");t=a.length>0?a[0].href.substring(0,a[0].href.lastIndexOf("/")+1)+e:window.location.href+e}return t}function DetectBrowser(){var e=navigator.userAgent.toLowerCase();return e.indexOf("firefox")>-1?"firefox":e.indexOf("opera")>-1?"opera":e.indexOf("msie")>-1?"msie":e.indexOf("safari")>-1?"safari":e.indexOf("rv:11.0")>-1?"msie":"unknown"}function loadPopup(e,t,a,r){var n=document.documentElement.activeElement||document.activeElement,o=null;n.getAttribute("page")?o=parseInt(n.getAttribute("page").split("_")[0]):document.body&&(o=parseInt(document.body.getAttribute("page").split("_")[0]));var l={};l.type=t,l.markupUrl=a,l.basePath=getAbsolutePath("./"),l.extra=r||"",l.pageId=o,l.markupId=e;var p=getElementAttrs(document.querySelector("#mark"+e)),i=markup(l),s=document.getElementById("mark"+e);s&&hasClass(s,"pageresource_updated")?multipleMarkupsCall(s,i,p):parent.render.loadResources.apply(parent.render,[extend(i,p)])}function multipleMarkupsCall(e,t,a){if(!hasClass(e,"multifile")){var r=window.getComputedStyle(e,":before"),n={bottom:parseFloat(r.bottom),height:parseFloat(r.height),left:parseFloat(r.left),right:parseFloat(r.right),top:parseFloat(r.top),width:parseFloat(r.width),x:parseFloat(r.left),y:parseFloat(r.top)},o=checkForMultipleMarkups(document,n);o.length>1&&!_markupListItemClicked?showMultipleMarkupPopup(document,o):(_markupListItemClicked=!1,parent.render.loadResources.apply(parent.render,[extend(t,a)]))}}function htmlActivity(e,t,a){var r=document.documentElement.activeElement||document.activeElement,n=null;r.getAttribute("page")?n=parseInt(r.getAttribute("page").split("_")[0]):document.body&&(n=parseInt(document.body.getAttribute("page").split("_")[0]));var o={type:"htmlwrap"};o.markupUrl=e,o.basePath=getAbsolutePath("./"),o.isResponsive=a,o.pageId=n;var l=getElementAttrs(document.querySelector("#mark"+t)),p=markup(o),i=document.getElementById("mark"+t);i&&hasClass(i,"pageresource_updated")?multipleMarkupsCall(i,p,l):parent.render.loadResources.apply(parent.render,[extend(p,l)])}function jumpToPage(e,t){var a=document.getElementById("mark"+t);if(hasClass(a,"pageresource_updated")){var r=window.getComputedStyle(a,":before"),n={bottom:parseFloat(r.bottom),height:parseFloat(r.height),left:parseFloat(r.left),right:parseFloat(r.right),top:parseFloat(r.top),width:parseFloat(r.width),x:parseFloat(r.left),y:parseFloat(r.top)},o=checkForMultipleMarkups(document,n);if(o.length>1&&!_markupListItemClicked)return void showMultipleMarkupPopup(document,o);_markupListItemClicked=!1,parent.render.navigateToPage.apply(parent.render,[e])}else parent.render.navigateToPage.apply(parent.render,[e])}function videoKalturaInlineBlob(e){event.target||event}function webLinks(e){var t=document.documentElement.activeElement||document.activeElement,a=null;t.getAttribute("page")?a=parseInt(t.getAttribute("page").split("_")[0]):document.body&&(a=parseInt(document.body.getAttribute("page").split("_")[0]));var r={type:"weblinks"};r.markupUrl=e.querySelector("a").href,r.basePath=getAbsolutePath("./"),r.pageId=a;var n=getElementAttrs(e),o=extend(getElementAttrs(e.querySelector("a")),n),l=markup(r),p=e.querySelector(".pageresource");p&&hasClass(p,"pageresource_updated")?multipleMarkupsCall(p,l,o):parent.render.loadResources.apply(parent.render,[extend(l,o)])}function getElementAttrs(e){var t={};if(e)for(var a=[].slice.call(e.attributes),r=a.length;r--;)"class"!=a[r].name&&"onclick"!=a[r].name&&"style"!=a[r].name&&(t[a[r].name]=a[r].value);return t}function markup(e){var t=e;switch(t.type){case"image":case"video":case"audio":case"documents":case"imgmagnify":t.markupUrl=getAbsolutePath(t.markupUrl);break;case"youtube":case"youtube_video":var a="//www.youtube.com/watch?v="+t.markupUrl+"&controls="+("false"===t["data-controls"]?0:1)+"&autoplay="+("false"===t["data-autoplay"]?0:1);t["data-theme"]&&t["data-theme"].toLowerCase(),t.markupUrl.split("&list=").length>1&&t.markupUrl.split("&list="),t.type=t.type,t.markupUrl=a;break;case"vimeo_video":t.markupUrl=a="//www.vimeo.com/"+t.markupUrl,t.type="vimeo";break;case"audioSync":t.markupUrl=getAbsolutePath(t.markupUrl),t.cuePointsXMLPath=getAbsolutePath(t.extra)}return t}function openHotspots(e,t){var a=document.documentElement.activeElement||document.activeElement,r=null;a.getAttribute("page")?r=parseInt(a.getAttribute("page").split("_")[0]):document.body&&(r=parseInt(document.body.getAttribute("page").split("_")[0]));for(var n=window.parent.document.getElementsByClassName("hotspot-menu");n.length>0;)n[0].parentNode.removeChild(n[0]);var o=window.parent.document.getElementById("epub_"+r),l=(ref=(o.contentDocument||o.contentWindow.document).querySelector('.active_section [id="'+e+'"]')).nextSibling?ref.nextSibling:ref.firstElementChild,p=getTranslate(o,{start:0,end:3}),i=p[0]>0?p[0]:1,s=getRelativeCoordinates(o,ref);(popover=l.cloneNode(!0)).querySelectorAll("span").forEach(function(e){titleText=e.innerText,e.setAttribute("title",titleText)}),popover.querySelectorAll("li").forEach(function(e){e.removeAttribute("onclick");var t={};t.basePath=getAbsolutePath("./"),t.pageId=r;var a=getElementAttrs(e),n=extend(getElementAttrs(e.querySelector("a")),a),o=extend(markup(t),n);let l=e=>this._onHotspotMarkupClick(e,o);e.removeEventListener("click",l),e.addEventListener("click",l)}),window.parent.document.body.appendChild(popover),popover.style.position="absolute",popover.style.display="flex",popover.style.left=o.getBoundingClientRect().left<s.left-popover.getBoundingClientRect().width?s.left-popover.getBoundingClientRect().width+10+"px":s.left-10+"px",popover.style.top=o.parentElement.getBoundingClientRect().height<s.top+popover.getBoundingClientRect().height-20?s.top-popover.getBoundingClientRect().height-ref.getBoundingClientRect().height*i+"px":s.top+"px"}parent.render=parent.angularComponentRef.render,document.addEventListener("click",function(e){if(closeMultiMarkupsPopup(e),ref){var t=document.documentElement.activeElement||document.activeElement,a=e.target,r=a.nextSibling;if(Object.is(a,ref)||Object.is(a,r))e.preventDefault(),t.getAttribute("page")&&parseInt(t.getAttribute("page").split("_")[0]);else for(var n=window.parent.document.getElementsByClassName("hotspot-menu");n.length>0;)n[0].parentNode.removeChild(n[0])}}),window.parent.document.addEventListener("click",function(e){if(ref){var t=e.target,a=t.nextSibling;if(Object.is(t,ref)||Object.is(t,a))e.preventDefault(),activeElement.getAttribute("page")&&parseInt(activeElement.getAttribute("page").split("_")[0]);else for(var r=window.parent.document.getElementsByClassName("hotspot-menu");r.length>0;)r[0].parentNode.removeChild(r[0])}}),void 0===NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),void 0===HTMLCollection.prototype.forEach&&(HTMLCollection.prototype.forEach=Array.prototype.forEach);var allMarkupOnPage=[].slice.call(document.querySelectorAll(".markup")),_markupListItemClicked=!1;function showMultipleMarkupPopup(e,t){var a=parent.document.getElementById("multiMarkupspopup");if(null==a){var r=parent.document.createElement("div");r.setAttribute("id","multiMarkupspopup"),parent.removeClass(r,"multiple-markups-popup"),parent.createCSSSelector(".multiple-markups-popup","position: absolute; display:block; flex-flow: column nowrap; padding: 6px 10px;z-index: 1000; background-color: #ededed; border: 1px solid #095e8e;max-height: 250px; overflow:auto; cursor: pointer;-webkit-box-shadow: 0 5px 15px rgba(0,0,0,0.4);-moz-box-shadow: 0 5px 15px rgba(0,0,0,0.4);box-shadow: 0 5px 15px rgba(0,0,0,0.4);",parent.document),parent.applyClass(r,"multiple-markups-popup"),parent.createCSSSelector(".multiple-markups-popup-parent","display: flex; flex: 1 100%; flex-flow: column nowrap; margin: 0px 10px; height:100%;",parent.document);for(var n=0;n<t.length;n++){(p=t[n].element).classList.add("markupOverlap"),(i=parent.document.createElement("div")).setAttribute("id",p.id),i.setAttribute("style","margin-top: 10px; width: 100%; height: 100%;flex-flow: row nowrap; display: flex; cursor: pointer;"),(s=parent.document.createElement("span")).style.color="black",s.style.position="relative",s.style.lineHeight="1",s.style.textAlign="center",s.style.flex="1 15%",s.style.height="35px",s.style.width="35px",s.setAttribute("class",p.className),parent.applyClass(s,"icons"),i.onclick=function(t){_markupListItemClicked=!0,e.getElementById(t.currentTarget.id).click(),r.style.display="none"};var o=parent.document.createElement("div");parent.removeClass(o,"multiple-markups-popup-parent"),parent.applyClass(o,"multiple-markups-popup-parent");var l=parent.document.createElement("label");parent.removeClass(l,"block-with-text"),parent.applyClass(l,"block-with-text"),l.innerHTML=p.id,o.appendChild(l),i.appendChild(s),i.appendChild(o),r.appendChild(i)}parent.document.body.appendChild(r),a=r}else for(a.innerHTML="",n=0;n<t.length;n++){var p,i,s;(p=t[n].element).classList.add("markupOverlap"),(i=parent.document.createElement("div")).setAttribute("id",p.id),i.setAttribute("style","margin-top: 10px; width: 100%; height: 100%;flex-flow: row nowrap; display: flex; cursor: pointer;"),(s=parent.document.createElement("span")).style.color="black",s.style.position="relative",s.style.flex="1 15%",s.style.height="35px",s.style.lineHeight="1",s.style.textAlign="center",s.style.width="35px",s.setAttribute("class",p.className),parent.applyClass(s,"icons"),i.onclick=function(t){_markupListItemClicked=!0,e.getElementById(t.currentTarget.id).click(),a.style.display="none"},o=parent.document.createElement("div"),parent.removeClass(o,"multiple-markups-popup-parent"),parent.applyClass(o,"multiple-markups-popup-parent"),l=parent.document.createElement("label"),parent.removeClass(l,"block-with-text"),parent.applyClass(l,"block-with-text"),l.innerHTML=p.id,o.appendChild(l),i.appendChild(s),i.appendChild(o),a.appendChild(i)}a.style.display="",parent.removeClass(a,"multiple-markups-popup"),parent.applyClass(a,"multiple-markups-popup");var u=e.body.getAttribute("page").split("_")[0],c=parent.document.querySelector("[epub-view-id='"+u+"']"),d=c.getBoundingClientRect(),m=parent.getScale(c),g=m[0]>0?m[0]:1,h=p.getBoundingClientRect();if(a.style.left=h.left*g+d.left+h.width*g+"px",a.style.top=h.top*g+d.top+h.height*g+"px",d.right-a.getBoundingClientRect().right<0){var f=Math.abs(d.right-a.getBoundingClientRect().right);a.style.left=a.offsetLeft-f+"px"}if(d.bottom-a.getBoundingClientRect().bottom<0){var v=Math.abs(d.bottom-a.getBoundingClientRect().bottom);a.style.top=a.offsetTop-v-h.height*g+"px"}parent.on("click",e,null,closeMultiMarkupsPopup),parent.on("click",window.parent.document,null,closeMultiMarkupsPopup)}function closeMultiMarkupsPopup(e){hasClass(e.target,"markupOverlap")}function checkForMultipleMarkups(e,t){var a=[],r=e.defaultView.getComputedStyle(e.getElementsByTagName("html")[0]).transform.split(",")[3];null==r&&(r=1);for(var n=e.getElementsByClassName("pageresource"),o=0;o<n.length;o++){var l=window.getComputedStyle(n[o],":before");rectOverlap({x:parseInt(parseFloat(l.top)/parseFloat(r)),y:parseInt(parseFloat(l.left)/parseFloat(r)),width:parseInt(parseFloat(l.width)/parseFloat(r)),height:parseInt(parseFloat(l.height)/parseFloat(r))},{x:parseInt(Math.round(t.top)/1),y:parseInt(Math.round(t.left+e.defaultView.scrollX)/1),width:parseInt(t.width/1),height:parseInt(t.height/1)})&&a.push({element:n[o]})}return a}function rectOverlap(e,t){var a=valueInRange(e.x,t.x,t.x+t.width)||valueInRange(t.x,e.x,e.x+e.width),r=valueInRange(e.y,t.y,t.y+t.height)||valueInRange(t.y,e.y,e.y+e.height);return a&&r}function valueInRange(e,t,a){return e<=a&&e>=t}function hasClass(e,t){return!!e&&("classList"in e?e.classList.contains(t):new Regexp(t).exec(e.className))}function is(e,t){if(t.nodeType)return e===t;for(var a="string"==typeof t?document.querySelectorAll(t):t,r=a.length;r--;)if(a[r]===e)return!0;return!1}function _onHotspotMarkupClick(e,t){e.preventDefault();for(var a=window.parent.document.getElementsByClassName("hotspot-menu");a.length>0;)a[0].parentNode.removeChild(a[0]);if(e.currentTarget.querySelectorAll("a").length>0)e.preventDefault(),webLinks(e.currentTarget);else{var r=document.getElementById(t.id);setTimeout(function(){r.click()},30)}}function glossaryBlob(e,t){var a=document.documentElement.activeElement||document.activeElement,r=null;a.getAttribute("page")?r=parseInt(a.getAttribute("page").split("_")[0]):document.body&&(r=parseInt(document.body.getAttribute("page").split("_")[0]));var n=getRelativeCoordinates(window.parent.document.getElementById("epub_"+r),t.target),o=t.target.id,l={type:"glossary",markupUrl:""};l.basePath=getAbsolutePath("./"),l.extra="",l.pageId=r,l.markupId=e,l.top=n.top,l.left=n.left;var p=getElementAttrs(document.querySelector("#"+o)),i=markup(l),s=document.getElementById("mark"+e);s&&hasClass(s,"pageresource_updated")?multipleMarkupsCall(s,i,p):parent.render.loadResources.apply(parent.render,[extend(i,p)])}function getTranslate(e,t){var a=[];if(window.getComputedStyle){var r=getComputedStyle(e),n=r.transform||r.webkitTransform||r.mozTransform||r.msTransform,o=n.match(/^matrix3d\((.+)\)$/);return o?parseFloat(o[1].split(", ")[13]):(o=n.match(/^matrix\((.+)\)$/),a.push(o?parseFloat(o[1].split(", ")[t.start]):0),a.push(o?parseFloat(o[1].split(", ")[t.end]):0),a)}}function getRelativeCoordinates(e,t,a){var r=0!=t.getClientRects().length?t.getClientRects()[0]:t.getBoundingClientRect(),n=getTranslate(e,{start:0,end:3}),o=n[0]>0?n[0]:1,l=e.getBoundingClientRect(),p=r.left*o+r.width*o+(a?1:l.left),i=r.top*o+r.height*o+(a?1:l.top);return console.log(p,i,"getRelativeCoordinates",o,r,l),{left:p,top:i,bounds:r}}allMarkupOnPage.forEach(function(e,t){e.addEventListener("click",function(e){var t=e.target,a="multi"===e.currentTarget.dataset.markuptype;if(this.querySelectorAll("a").length>0&&!1===a)return e.preventDefault(),void webLinks(this);is(t,"a")||hasClass(t,"noresource")||hasClass(t,"pageresource")||is(t,"li")||(t.querySelectorAll("a").length>0&&!a?(e.preventDefault(),webLinks(t)):a?t.querySelector(".pageresource")&&setTimeout(function(){t.querySelector(".pageresource").click()},30):setTimeout(function(){t.children[0].click()},30))})}),Object.is||(Object.is=function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t});var isExternal=function(e){return(e.indexOf(":")>-1||e.indexOf("//")>-1)&&checkDomain(location.href)!==checkDomain(e)},checkDomain=function(e){return 0===e.indexOf("//")&&(e=location.protocol+e),e.toLowerCase().replace(/([a-z])?:\/\//,"$1").split("/")[0]};function extend(e){var t=[].slice.call(arguments,1);return t.forEach(function(t){t&&Object.getOwnPropertyNames(t).forEach(function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))})}),e}